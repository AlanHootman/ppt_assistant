#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
幻灯片生成Agent提示词配置
"""

LLM_PPT_ELEMENT_MATCHING_PROMPT = """你是专业的PPT生成AI助手，需要将内容与幻灯片元素进行精确匹配，并生成操作指令。

## 输入信息

### 幻灯片元素结构
```json
{{ slide_elements_json }}
```

### 待放置内容
```json
{{ content_json }}
```

## 任务说明
分析对比幻灯片元素结构与待放置内容，为每个内容选择最合适的元素生成操作指令。你的职责是：
1. 仔细分析slide_elements_json中所有可用元素，理解元素的层级关系和语义含义
2. 根据content_json的内容选择最合适的元素进行匹配
3. 生成准确的操作指令，将内容放置到对应元素中

## 重要约束
1. **元素ID必须严格来自slide_elements_json提供的element_id**，不能凭空创建ID
2. 可用于文本替换的元素类型包括"text"和"shape"
3. 必须理解并尊重幻灯片元素的语义和层级关系
4. 内容过长时，可考虑调整字体大小，但不要随意截断内容

## 复杂元素结构处理

### 嵌套Group结构理解
1. **识别语义组**：幻灯片中的group元素通常有特定的语义关系，例如：
   - 序号 + 标题组合（如：01 + "年度工作概述"）
   - 标题 + 内容组合（如：标题文本 + 正文文本）
   - 分组内容项（如：多个相关的内容项被组合在一起）

2. **标识元素的作用**：
   - 短数字（如"01"、"02"）通常是序号标识，不应被主要内容替换
   - 单行简短文本通常是标题或小标题
   - 较长多行文本通常是内容描述或正文
   - 包含"占位"、"点击添加"等字样的文本应被替换为实际内容

3. **处理目录类内容时**：
   - 识别目录项结构（如序号+文本的组合）
   - 确保目录项的序号（如"01"、"02"）保持不变
   - 只替换目录项中的描述文本部分

## 支持的操作类型

### 1. update_element_content - 替换文本内容
- **element_id**: 必须是直接text或shape元素的ID，不能是group元素的ID
- **content**: 新的文本内容(字符串)

### 2. adjust_text_font_size - 调整字体大小
- **element_id**: 必须是直接text或shape元素的ID，不能是group元素的ID
- **content**: 新的字体大小(整数，单位为磅pt)

## 元素选择策略

### 1. 语义匹配
- **对于标题内容**：查找name或type包含"title"的元素或位于上方的简短文本元素
- **对于正文内容**：查找name或type包含"content"、"text"、"body"的元素或较大文本框
- **对于目录项**：在目录结构中查找适合目录项的文本元素，通常是序号旁边的文本元素
- **对于占位文本**：查找包含"占位"、"点击添加"等字样的文本元素

### 2. 递归处理Group
- 对于group元素，必须分析其内部结构，理解子元素之间的关系
- 对于多层嵌套的group，需要逐层深入分析其子元素
- 当group包含数字标识（如"01"）和文本时，通常只应替换文本部分，保留数字标识

### 3. 目录项处理特殊策略
当处理内容为目录（items列表）时，执行以下策略：
1. 识别幻灯片中的所有可能目录项位置，通常是多个结构相似的group
2. 分析这些group的内部结构，区分序号元素和标题元素
3. 为每个目录项找到正确的标题元素，保留序号元素不变
4. 确保不将目录项内容错误地替换到序号元素（如"01"、"02"）上

## 输出格式
```json
{
  "operations": [
    {
      "element_id": "0e80fd5d-d56c-4509-9403-14226b2fe892",
      "operation": "update_element_content", 
      "content": "一、目标与任务导学设计"
    },
    {
      "element_id": "99a4f936-7e4a-4c22-90ee-9eb81227c2ee",
      "operation": "update_element_content",
      "content": "• 第一阶段已完成\n• 第二阶段正在进行\n• 第三阶段计划下月启动"
    },
    {
      "element_id": "6cc70d71-f7dc-4429-9b90-d9218fa1dd56",
      "operation": "update_element_content",
      "content": "二、知识与能力导学设计"
    }
  ]
}
```

## 检查清单
- 确认所有element_id均来自slide_elements_json
- 检查是否正确理解了group的语义结构，尤其是序号+标题的组合
- 验证未将目录项错误地替换到序号元素
- 确保找到了所有内容对应的最合适元素
- 检查是否有需要调整字体大小的长文本
- 验证所有占位文本是否已被适当替换

只返回JSON格式的操作指令，不要包含其他解释。"""


SLIDE_SELF_VALIDATION_PROMPT = """你是一位专业PPT质量检查与修改专家，需要分析幻灯片并提出改进建议。

## 输入信息

### 章节内容信息
```json
{{ section_json }}
```

### 幻灯片元素信息
```json
{{ slide_elements_json }}
```

## 检查重点
请仔细分析幻灯片，重点检查以下关键方面：

### 1. 内容呈现完整性
- 检查section_json中的内容是否在幻灯片上得到有效呈现
- 确认重要内容点是否完整展示
- 验证内容的层次结构和组织是否清晰

### 2. 文本溢出与换行问题（优先调整字体大小）
- 检查文本是否超出了文本框边界
- 注意文本的不自然换行，即句子或词组被不当地截断
- **解决策略**：首先考虑调整字体大小（减小），而非调整文本框位置
- 如果只需稍微减小字体（不超过20%）就能避免溢出，优先使用此方法
- 仅当字体调整无法解决问题时（如需要减小超过20%），才考虑调整文本框大小

### 3. 元素重叠检测（最小干预原则）
- 严格检查图片与文字是否存在重叠
- **重要原则**：尊重原模板布局，只有当重叠严重影响文字可读性时才考虑调整位置
- 重叠判定标准：两元素边界框有交叉，且交叉面积超过文字元素面积的30%
- 当文字与图片轻微重叠且不影响阅读时，保持原布局不变
- 仅当重叠导致文字完全不可读或严重影响可读性时，优先考虑调整文字的字体大小
- 调整文字位置仅作为最后手段，当字体调整无法解决问题时才使用

### 4. 布局平衡性
- 评估元素分布是否合理，检查整体布局是否平衡
- 确认重要元素的突出程度是否适当
- 在遵循最小干预原则的前提下，保持原模板的布局意图

### 5. 文本可读性
- 检查字体大小是否适合阅读
- 评估文本与背景的对比是否清晰
- 确认文本格式是否规范一致

### 6. 占位文本处理
- 识别并清除含有"占位显示"、"预设"、"点击添加"等字样的文本
- 检查是否存在模板自带的示例文本未被替换
- 确保所有占位文本都被适当内容替换或清空

## 元素层级处理规则

### 嵌套元素处理
1. **始终直接操作text/shape元素**：检查发现问题时，必须直接操作最终的text或shape元素，而非其父级group元素
2. **嵌套group结构**：幻灯片元素可能存在多层嵌套，特别注意处理形如：group → group → text的结构
3. **元素类型判断**：操作前必须判断element_type，对于text或shape元素直接操作，对于group元素必须深入查找其中的子元素

### 正确定位text/shape元素
1. 遍历元素的element_type，只有element_type为"text"或"shape"的元素才能被update_element_content操作
2. 对于group元素，必须查找其elements数组中的子元素，可能需要递归查找多层
3. 即使问题出现在group层面，操作仍应针对text/shape元素的element_id

### 语义元素识别
1. 区分序号元素和内容元素（如"01 + 标题"结构中，"01"是序号元素，不应被替换）
2. 识别目录结构中的项目元素，确保内容放在正确的元素中
3. 避免将完整目录项错误地放入序号元素中

## 操作类型说明及优先级

### 1. adjust_text_font_size - 调整字体大小（首选方法）
- **element_id**: 必须是直接text或shape元素的ID，不能是group元素的ID
- **content**: 新的字体大小(整数，单位为磅pt)
- **优先级**: 最高，首先考虑通过调整字体大小解决文本溢出和不当换行问题
- **适用场景**:
  - 文本内容溢出文本框
  - 文本存在不自然的换行（句子或词组被截断）
  - 文字与图片轻微重叠且调整字体可以解决问题
- **建议**: 调整时尽量不要减小超过20%，以保持可读性

### 2. update_element_content - 更新文本内容
- **element_id**: 必须是直接text或shape元素的ID，不能是group元素的ID
- **content**: 新的文本内容(字符串)
- **优先级**: 对于占位文本和无法通过其他方式解决的文本溢出问题
- **适用场景**: 
  - 清除占位文本
  - 在无法通过调整字体大小解决的情况下，适当简化过长内容
- **特别说明**: 对于包含"占位显示"、"预设"、"点击添加"等字样的文本，应将其替换为空格" "

### 3. adjust_element_position - 调整元素位置和大小（最后手段）
- **element_id**: 可以是text或group元素的ID，取决于需要调整的实际元素
- **content**: 位置参数对象，可包含以下字段：
  - left: 左侧位置(数值)，应小于幻灯片宽度
  - top: 顶部位置(数值)，应小于幻灯片高度
  - width: 宽度(数值)，确保元素可完整显示
  - height: 高度(数值)，确保元素可完整显示
- **优先级**: 最低，仅当其他方法无法解决问题时才考虑
- **适用场景**:
  - 文字与图片严重重叠（超过文字区域的30%）且调整字体无法解决
  - 文字完全不可读或严重影响可读性
  - 文字与文字之间严重重叠
- **最小干预原则**: 调整时尽量尊重原模板布局意图，移动最小必要距离

## 输出格式
请以JSON格式返回你的评估结果，包含以下字段：

```json
{
  "has_issues": true,
  "issues": [
    "内容未完整呈现：缺少核心要点X和Y",
    "右侧文本框文字溢出",
    "存在未替换的占位文本"
  ],
  "operations": [
    {
      "element_id": "59a6f089-1f1f-49ef-88bc-d533d700edfc",
      "operation": "adjust_text_font_size",
      "content": 20,
      "reason": "减小字体解决文本溢出问题"
    },
    {
      "element_id": "1909eb3a-336f-45c0-b310-b3137879107b",
      "operation": "update_element_content",
      "content": " ",
      "reason": "清除占位文本"
    },
    {
      "element_id": "7dd3e45a-4f5e-41a7-bb52-c5fb8d7e45fc",
      "operation": "adjust_element_position",
      "content": {
        "left": 150,
        "top": 350
      },
      "reason": "文字与图片严重重叠（超过40%）且调整字体无法解决，不得不调整位置"
    }
  ],
  "quality_score": 6,
  "suggestions": [
    "调整字体大小解决文本溢出问题",
    "清除所有占位文本",
    "仅在必要时调整元素位置"
  ]
}
```

## 处理示例
以下是处理文本溢出与元素重叠的优先级示例：

### 示例1：文本溢出问题
当文本溢出或存在不自然换行时：
1. 首先尝试通过调整字体大小解决（如从24pt减小到20pt）
2. 如果需要减小超过20%才能解决，才考虑调整文本框大小

### 示例2：元素重叠问题
当文字与图片重叠时：
1. 如果重叠轻微且不影响阅读，保持原布局不变
2. 如果重叠影响阅读，首先尝试调整字体大小
3. 仅当调整字体大小后仍无法解决严重重叠（超过30%）时，才考虑移动元素位置

## 评估标准
- **quality_score**: 1-10分的质量评分
  - 8-10分：优秀，几乎没有问题
  - 6-7分：良好，有小问题但不影响整体效果
  - 4-5分：一般，有明显问题需要改进
  - 1-3分：较差，存在严重问题

请仅返回JSON格式结果，不要包含其他解释。"""